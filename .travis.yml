dist: xenial
language: python
python:
  - 3.8.1
env:
  global:
  - secure: raFx+DD0LWE+U51Dp+d2dnbaxv18VEK9XC2sobMI5TDci1QREJ1qip/2YRn9tPFoWPktHV21zOacepDu4NL2rUOx7Bf2Q3oQwpWyH9xOh8mdOxXUJMRMOfSzDmaRR8hGfMd0NqJZB7/PB7B3XXGnHMdNIzq+9jDL5PkqWs/ZV+dYNFyRf5VKDLtC5+275LxeyeIm3RDwygZ33xCHxiRdbRvFZ8d7j071ceEXiqRkTXcLWgn6FYw6juahl9ZHg6XOPUtwWJcvhYrSHrPjk+Y21+8PQ0bPc4yV6iBuwa5oEeBylGzI757zF5S0ARYCTr4Sw+loWSD/4W9vGQmfse6o9Th0o0MrF0BdhJX/EuiRoDhQrEcnBZgF5b3ZXMXkmeECC6itpAXFR6lDFaNkhzWiBXQIz0MNG0nmQn/98iBLD0Bw1LwXRw0U6KErDQgNp7+rQeYnbsgCHEtxCaeNNfnJbMUFDy2OYA3t2SE0xp99DAAjpvbbwp1MjAteXbcQJ9/xdSijqzoqvF4sK8Qw91D/zs+wokg7fIItkrPS6hxEvKjNgUFlQM6FUizlmONvvk8tFbLp+pxM9XQOLGnlm165uVWSs1BiGlbU5l+/sppRxRI6LcwcAFKSZqX54A2F8eeWdVwy7WNoGzpgy6L+67yOguAlHCrZ3C5R6Hz9rqUggPU=
before_script:
  - python --version
  - pip install -r requirements.txt
script:
  - |
    if [ $TRAVIS_PULL_REQUEST == true ] && [ $TRAVIS_BRANCH != "master" ]; then
      VERSION="v$(cat main/root.template | shyaml get-value Globals.Function.Environment.Variables.VERSION)"
      git tag $VERSION
    fi
before_deploy:
  - VERSION="v$(cat main/root.template | shyaml get-value Globals.Function.Environment.Variables.VERSION)"
  - if [ -z "$TRAVIS_TAG" ]; then git tag $VERSION; fi
  - zip -r "$VERSION.zip" -@ < ci/include.lst
deploy:
  - provider: releases
    api_key:
      secure: "$GITHUB_TOKEN"
    file: "$VERSION.zip"
    skip_cleanup: true
    on:
      branch: master
      condition: type != pull_request
  - provider: script
    script: aws s3 cp ./$VERSION.zip s3://$CFN_BUCKET/aws-digital-content-creation-render-environment/$VERSION/aws-digital-content-creation-render-environment.zip
    skip_cleanup: true
    on:
      tags: true
notifications:
  email: false
cache: pip
